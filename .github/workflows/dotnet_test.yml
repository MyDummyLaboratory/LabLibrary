name: .Net Test

on: [push]

env:
  # Path of the Project being Tested and Packaged.
  PROJECT_PATH: 'LabLibrary/LabLibrary.csproj'
  # Output directory for the NuGet Package
  PKG_OUTPUT_DIR: ${{ github.workspace }}/output
  # URL of the Github Package Repository
  NUGET_SRC_URL: https://nuget.pkg.github.com/MyDummyLaboratory/index.json

  # Token automatically generated by Github for the workflow 
  GITHUB_TOKEN: ${{ github.token }} 

jobs:
  build-and-test:

    runs-on: ubuntu-latest

    steps:
    - name: Check-out Repository
      uses: actions/checkout@v3

    - name: Setup .Net
      uses: actions/setup-dotnet@v2
      with:
        dotnet-version: 6.0.x

    -name: Restore Dependencies
      run: dotnet restore

    - name : Build Solution
      run: dotnet build --no-restore --configuration Release

    - name : Test Project
      run: dotnet test --no-build --verbosity normal

    - name: Create NuGet Package
      run: 
        dotnet pack ${{ env.PROJECT_PATH }} --no-build -p:IncludeSymbols=true -p:SymbolPackageFormat=snupkg
        --configuration Release -p:PackageVersion=0.0.4 --output ${{ env.PKG_OUTPUT_DIR }}

    - name: Push NuGet Package
      run: |
        dotnet nuget push ${{ env.PKG_OUTPUT_DIR }}/*.nupkg --api-key ${{ env.GITHUB_TOKEN }} --source ${{ env.NUGET_SRC_URL }}
        dotnet nuget push ${{ env.PKG_OUTPUT_DIR }}/*.snupkg --api-key ${{ env.GITHUB_TOKEN }} --source ${{ env.NUGET_SRC_URL }}

